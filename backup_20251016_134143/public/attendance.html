<!DOCTYPE html><html><head><meta charset="utf-8"><title>Attendance</title>
<style>body{font-family:sans-serif;max-width:900px;margin:20px auto}table{border-collapse:collapse;width:100%}th,td{border:1px solid #ccc;padding:6px}</style>
</head><body>
<h1>Attendance</h1>
<p><a href="index.html">Back</a></p>

<div>
  <label>Student <select id="student"><option value="">(Select)</option></select></label>
  <label>Date <input id="date" type="date"></label>
  <label>Present <select id="present"><option value="1">Yes</option><option value="0">No</option></select></label>
  <button id="add">Add</button>
</div>

<table>
  <thead><tr><th>ID</th><th>Name</th><th>Date</th><th>Present</th><th>Actions</th></tr></thead>
  <tbody id="tb"></tbody>
</table>

<script>
let students=[]; const idToName=new Map();
async function loadStudents(){
  const r=await fetch('/api/students'); students=await r.json(); students.forEach(s=>idToName.set(s.id, (s.first_name||'')+' '+(s.last_name||'')));
  const sel=document.getElementById('student'); sel.innerHTML='<option value="">(Select)</option>';
  students.forEach(s=>{ const o=document.createElement('option'); o.value=String(s.id); o.textContent=idToName.get(s.id); sel.appendChild(o); });
}
function nm(id){ return idToName.get(id)||('ID '+id); }
async function load(){
  const r=await fetch('/api/attendance'); const list=await r.json(); const tb=document.getElementById('tb'); tb.innerHTML='';
  (list||[]).forEach(a=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${a.id}</td><td>${nm(a.student_id)}</td><td>${a.date||''}</td><td>${Number(a.present)?'Yes':'No'}</td>
      <td><button class="edit" data-id="${a.id}">Edit</button> <button class="del" data-id="${a.id}">Delete</button></td>`;
    tb.appendChild(tr);
  });
}
document.getElementById('add').onclick=async()=>{
  const student_id=document.getElementById('student').value;
  const payload={ student_id, date:document.getElementById('date').value, present:document.getElementById('present').value==='1' };
  if(!student_id || !payload.date){ alert('Student and date required'); return; }
  const r=await fetch('/api/attendance',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  if(!r.ok){alert('Add failed');return;} load();
};
document.addEventListener('click',async(e)=>{
  if(e.target.matches('.del')){ if(!confirm('Delete?'))return;
    const r=await fetch('/api/attendance/'+e.target.dataset.id,{method:'DELETE'}); if(r.ok) load(); else alert('Delete failed'); }
  if(e.target.matches('.edit')){
    const id=e.target.dataset.id; const row=e.target.closest('tr'); const t=row.children;
    const date   = prompt('Date (YYYY-MM-DD):', t[2].textContent)||''; if(date===null) return;
    const present= confirm('Present? OK=Yes, Cancel=No');
    // NOTE: student change via edit not included (keeps same student)
    const nameCell = t[1].textContent; const s = students.find(x => (x.first_name+' '+x.last_name)===nameCell);
    const student_id = s ? s.id : null;
    const r=await fetch('/api/attendance/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({student_id,date,present})});
    if(r.ok) load(); else alert('Update failed');
  }
});
(function(){ const t=new Date(); document.getElementById('date').value=t.toISOString().slice(0,10);})();
(async()=>{ await loadStudents(); await load(); })();
</script>
</body></html>
