<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Leads</title>
  <style>
    body{font-family:sans-serif;max-width:900px;margin:2rem auto}
    table{border-collapse:collapse;width:100%} th,td{border:1px solid #ccc;padding:6px}
    input,button{margin:2px}
  </style>
</head>
<body>
  <h1>Leads</h1>
  <div>
    <input id="name"  placeholder="Name">
    <input id="phone" placeholder="Phone">
    <input id="email" placeholder="Email">
    <input id="program" placeholder="Interested Program">
    <button id="add">Add Lead</button>
  </div>

  <h2>Lead List</h2>
  <table>
    <thead><tr><th>ID</th><th>Name</th><th>Phone</th><th>Email</th><th>Program</th><th>Actions</th></tr></thead>
    <tbody id="body"></tbody>
  </table>

  <p><a href="index.html">Back to Main Page</a></p>

  <script>
    async function load(){
      const r = await fetch('/api/leads');
      const rows = await r.json();
      const tb = document.getElementById('body'); tb.innerHTML='';
      rows.forEach(L=>{
        const [first,...rest] = String(L.name||'').trim().split(' ');
        const last = rest.join(' ');
        const toStudents = `students.html?first_name=${encodeURIComponent(first||'')}&last_name=${encodeURIComponent(last||'')}&phone=${encodeURIComponent(L.phone||'')}&email=${encodeURIComponent(L.email||'')}&program=${encodeURIComponent(L.interested_program||'')}`;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${L.id}</td>
          <td>${L.name||''}</td>
          <td>${L.phone||''}</td>
          <td>${L.email||''}</td>
          <td>${L.interested_program||''}</td>
          <td>
            <button class="edit" data-id="${L.id}">Edit</button>
            <button class="del"  data-id="${L.id}">Delete</button>
            <a href="${toStudents}">Lead → Student</a>
          </td>`;
        tb.appendChild(tr);
      });
    }

    document.addEventListener('click', async (e)=>{
      if(e.target.id==='add'){
        const payload = {
          name:  document.getElementById('name').value.trim(),
          phone: document.getElementById('phone').value.trim() || null,
          email: document.getElementById('email').value.trim() || null,
          interested_program: document.getElementById('program').value.trim() || null
        };
        if(!payload.name){ alert('Name is required'); return; }
        const r = await fetch('/api/leads', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if(r.ok){ document.getElementById('name').value=''; load(); } else alert('Error adding lead');
      }
      if(e.target.matches('.del')){
        const id = e.target.dataset.id;
        if(!confirm('Delete this lead?')) return;
        const r = await fetch('/api/leads/'+id, { method:'DELETE' });
        if(r.ok) load(); else alert('Error deleting');
      }
      if(e.target.matches('.edit')){
        const id = e.target.dataset.id;
        const L = await (await fetch('/api/leads/'+id)).json();
        const name  = prompt('Name:',  L.name||'');  if(name===null) return;
        const phone = prompt('Phone:', L.phone||''); if(phone===null) return;
        const email = prompt('Email:', L.email||''); if(email===null) return;
        const prog  = prompt('Interested Program:', L.interested_program||''); if(prog===null) return;
        const r = await fetch('/api/leads/'+id, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name, phone, email, interested_program: prog }) });
        if(r.ok) load(); else alert('Error updating');
      }
    });

    load();
  </script>
</body>
</html>
