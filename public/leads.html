<!DOCTYPE html><html lang="en"><head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Leads</title>
<link rel="stylesheet" href="main.css"/>
</head><body><div class="container">
  <h1>Leads</h1>

  <div class="card">
    <h2>Add / Edit Lead</h2>
    <div class="grid">
      <input id="name" placeholder="Name">
      <input id="phone" placeholder="Phone">
      <input id="email" placeholder="Email">
      <input id="interested_program" placeholder="Interested Program">
      <input id="follow_up_date" type="date" placeholder="Follow-up date">
    </div>
    <div class="toolbar">
      <button class="btn btn-primary" id="saveLead">Add Lead</button>
      <span class="badge" id="status"></span>
    </div>
  </div>

  <div class="card">
    <h2>Leads List</h2>
    <table class="table" id="leadsTable">
      <thead><tr><th>Name</th><th>Phone</th><th>Program</th><th>Follow-up</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <p><a href="index.html">Back to Main</a></p>
</div>
<script>
const $ = s => document.querySelector(s);
const api = (p,opt)=>fetch(p,opt).then(r=>r.ok?r.json():r.json().then(e=>Promise.reject(e)));

let editingId = null;

async function load(){
  const rows = await api("/api/leads");
  const tb = document.querySelector("#leadsTable tbody"); tb.innerHTML = "";
  rows.forEach(l=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${l.name||""}</td>
      <td>${l.phone||""}</td>
      <td>${l.interested_program||""}</td>
      <td>${l.follow_up_date||""}</td>
      <td>
        <button class="btn" data-act="edit" data-id="${l.id}">Edit</button>
        <button class="btn btn-danger" data-act="del" data-id="${l.id}">Delete</button>
        <button class="btn btn-primary" data-act="convert" data-id="${l.id}">Convert â†’ Student</button>
      </td>`;
    tb.appendChild(tr);
  });
}

document.querySelector("#leadsTable").addEventListener("click", async (e)=>{
  const b = e.target.closest("button"); if (!b) return;
  const id = b.dataset.id, act = b.dataset.act;
  try{
    if (act==="edit"){
      const l = await api("/api/leads/"+id);
      ["name","phone","email","interested_program","follow_up_date"].forEach(k=>{
        const el = document.getElementById(k); if (el) el.value = l[k]||"";
      });
      editingId = id;
      $("#saveLead").textContent = "Save Lead";
      $("#status").textContent = "Editing #"+id;
    } else if (act==="del"){
      await api("/api/leads/"+id, { method:"DELETE" });
      load();
    } else if (act==="convert"){
      await api(`/api/leads/${id}/convert`, { method:"POST" });
      load();
      alert("Lead converted to student.");
    }
  }catch(err){
    alert(err.error || "Action failed");
  }
});

document.getElementById("saveLead").onclick = async ()=>{
  const body = {
    name: $("#name").value.trim(),
    phone: $("#phone").value.trim(),
    email: $("#email").value.trim(),
    interested_program: $("#interested_program").value.trim(),
    follow_up_date: $("#follow_up_date").value
  };
  const opt = { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) };
  try{
    if (editingId){
      await api("/api/leads/"+editingId, { ...opt, method:"PUT" });
      editingId = null; $("#saveLead").textContent = "Add Lead";
    } else {
      await api("/api/leads", opt);
    }
    $("#status").textContent = "Saved.";
    load();
  }catch(err){ alert(err.error || "Save failed"); }
};

load();
</script>
</body></html>