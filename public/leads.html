<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Leads</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:20px}
    .nav{margin-bottom:16px}
    .nav a{text-decoration:none;padding:6px 10px;border:1px solid #ccc;border-radius:6px;background:#f7f7f7}
    form input, form textarea, form button{padding:8px;margin:4px 6px 4px 0}
    form textarea{vertical-align:middle}
    table{border-collapse:collapse;width:100%;margin-top:16px}
    th, td{border:1px solid #ddd;padding:8px;text-align:left}
    .small{font-size:.9em;color:#666}
    button{cursor:pointer}
  </style>
</head>
<body>
  <div class="nav"><a href="index.html">⬅ Back to Main</a></div>
  <h1>Leads</h1>

  <form id="leadForm">
    <input name="name" placeholder="Name" required>
    <input name="phone" placeholder="Phone">
    <input name="email" placeholder="Email">
    <textarea name="notes" placeholder="Notes" rows="2" cols="30"></textarea>
    <button type="submit">Add Lead</button>
    <span class="small">Saved instantly; you can convert to student later.</span>
  </form>

  <table id="tbl">
    <thead>
      <tr>
        <th>ID</th><th>Name</th><th>Phone</th><th>Email</th><th>Notes</th><th>Created</th><th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
async function fetchJSON(url, opts){
  const r = await fetch(url, opts);
  const t = await r.text();
  try { return JSON.parse(t); } catch { return { ok:false, error:'Invalid JSON', raw:t }; }
}
async function load(){
  const tb = document.querySelector('#tbl tbody');
  tb.innerHTML = '<tr><td colspan="7">Loading…</td></tr>';
  const data = await fetchJSON('/api/leads');
  if (!data.ok){ tb.innerHTML = `<tr><td colspan="7">Error: ${data.error||data.raw}</td></tr>`; return; }
  tb.innerHTML = '';
  for (const L of data.leads){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${L.id}</td>
      <td>${L.name||''}</td>
      <td>${L.phone||''}</td>
      <td>${L.email||''}</td>
      <td>${L.notes||''}</td>
      <td>${L.created_at||''}</td>
      <td>
        <button data-convert="${L.id}">Convert → Student</button>
      </td>`;
    tb.appendChild(tr);
  }
}
document.getElementById('leadForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const body = Object.fromEntries(fd.entries());
  const res = await fetchJSON('/api/leads',{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  if (!res.ok){ alert('Error: ' + res.error); return; }
  e.target.reset(); load();
});
document.querySelector('#tbl').addEventListener('click', async (e)=>{
  const id = e.target?.dataset?.convert;
  if (!id) return;
  if (!confirm('Convert this lead to a Student now?')) return;
  const res = await fetchJSON(`/api/leads/${id}/convert`, { method:'POST' });
  if (!res.ok){ alert('Error: ' + res.error); return; }
  alert(`Converted! New student #${res.student_id}`);
  load();
});
load();
</script>
</body>
</html>
