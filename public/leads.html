<!-- leads.html build v2025-10-10-6 (adds follow-up badges/colors) -->
<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>Leads</title>
  <link rel="stylesheet" href="styles.css?v=2" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head><body>
<h1>Leads</h1><p><a href="index.html">← Back to Main</a></p>

<div id="err" class="error"></div>

<h2>Add Lead</h2>
<div class="row">
  <input id="name" placeholder="Name" />
  <input id="phone" placeholder="Phone" />
  <input id="email" placeholder="Email" />
  <input id="interested_program" placeholder="Interested Program" />
  <input id="follow_up_date" type="date" />
  <select id="status"><option>new</option><option>contacted</option><option>converted</option><option>lost</option></select>
  <input id="notes" placeholder="Notes" />
  <button id="addBtn">Add Lead</button>
</div>

<h2>Leads List</h2>
<table id="leadTable"><thead>
  <tr><th>Name</th><th>Phone</th><th>Email</th><th>Program</th><th>Follow-up</th><th>Status</th><th>Notes</th><th>Actions</th></tr>
</thead><tbody></tbody></table>
<p class="note muted">Marker: leads.html build v2025-10-10-6</p>

<script>
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const err=$('#err'); function showError(m){err.textContent=m||''; err.style.display=m?'block':'none';}
function todayISO(){return new Date().toISOString().slice(0,10)}
function daysOverdue(iso){ if(!iso) return null; const delta=Math.floor((new Date(todayISO())-new Date(iso))/(1000*60*60*24)); return delta; }
function followBadge(iso,status){
  if(!iso) return {html:'<span class="badge info">No date</span>', row:''};
  if(status==='converted' || status==='lost') return {html:'<span class="badge ok">'+status+'</span>', row:''};
  const d=daysOverdue(iso); // days past due (>=0 means due today/past)
  if (d===null) return {html:'',row:''};
  if (d < 0) return {html:`<span class="badge info">In ${-d}d</span>`, row:''};       // future date
  if (d >= 30) return {html:`<span class="badge danger2">${d}d overdue</span>`, row:'followup-4'};
  if (d >= 14) return {html:`<span class="badge danger">${d}d overdue</span>`,  row:'followup-3'};
  if (d >= 7)  return {html:`<span class="badge warn2">${d}d overdue</span>`,  row:'followup-2'};
  if (d >= 3)  return {html:`<span class="badge warn">${d}d overdue</span>`,   row:'followup-1'};
  if (d >= 0)  return {html:`<span class="badge warn">Due</span>`,             row:'followup-1'};
  return {html:'',row:''};
}

async function loadLeads(){
  showError('');
  const arr=await (await fetch('/api/leads')).json();
  const tbody=$('#leadTable tbody'); tbody.innerHTML='';
  for(const l of arr){
    const sev=followBadge(l.follow_up_date,l.status);
    const tr=document.createElement('tr');
    if(sev.row) tr.classList.add(sev.row);
    tr.innerHTML=`
      <td>${l.name||''}</td>
      <td>${l.phone||''}</td>
      <td>${l.email||''}</td>
      <td>${l.interested_program||''}</td>
      <td>${(l.follow_up_date||'')} ${sev.html}</td>
      <td>
        <select data-id="${l.id}" class="status">
          ${['new','contacted','converted','lost'].map(s=>`<option ${s===l.status?'selected':''}>${s}</option>`).join('')}
        </select>
      </td>
      <td>${l.notes||''}</td>
      <td>
        <button data-id="${l.id}" class="del">Delete</button>
        ${l.status!=='converted' ? `<button data-id="${l.id}" class="convert">Convert to Student</button>` : ''}
      </td>`;
    tbody.appendChild(tr);
  }
  $$('#leadTable .del').forEach(b=>b.onclick=async()=>{await fetch('/api/leads/'+b.dataset.id,{method:'DELETE'}); loadLeads();});
  $$('#leadTable .status').forEach(sel=> sel.onchange=async()=>{await fetch('/api/leads/'+sel.dataset.id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:sel.value})}); loadLeads();});
  $$('#leadTable .convert').forEach(btn => btn.onclick = async () => {
    showError('');
    try{
      const res = await fetch('/api/leads/'+btn.dataset.id+'/convert',{method:'POST'});
      if(!res.ok){ throw new Error(await res.text()); }
      const info = await res.json();
      alert(info.created_new ? 'Student created from lead.' : 'Existing student updated from lead.');
      loadLeads();
    }catch(e){ showError(e.message||'Conversion failed.'); }
  });
}

$('#addBtn').onclick=async()=>{
  showError('');
  const p={name:$('#name').value,phone:$('#phone').value,email:$('#email').value,interested_program:$('#interested_program').value,follow_up_date:$('#follow_up_date').value,status:$('#status').value,notes:$('#notes').value};
  await fetch('/api/leads',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)});
  $('#name').value=$('#phone').value=$('#email').value=''; $('#interested_program').value=$('#follow_up_date').value=''; $('#notes').value='';
  loadLeads();
};
loadLeads();
</script>
</body></html>
