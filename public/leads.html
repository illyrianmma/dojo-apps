<!DOCTYPE html><html lang="en"><head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Leads</title>
<link rel="stylesheet" href="main.css"/>
</head><body><div class="container">
  <h1>Leads</h1>
  <div class="card">
    <h2>Add Lead</h2>
    <div class="grid">
      <input id="name" placeholder="Name">
      <input id="phone" placeholder="Phone">
      <input id="email" placeholder="Email">
      <input id="interested_program" placeholder="Interested Program">
      <input id="follow_up_date" type="date" placeholder="Follow-up date">
    </div>
    <div class="toolbar">
      <button class="btn btn-primary" id="addLead">Add Lead</button>
      <span class="badge" id="status"></span>
    </div>
  </div>

  <div class="card">
    <h2>Leads List</h2>
    <table class="table" id="leadsTable">
      <thead><tr><th>Name</th><th>Phone</th><th>Program</th><th>Follow-up</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <p><a href="index.html">Back to Main</a></p>
</div>

<script>
const $ = s=>document.querySelector(s);
const api = (p,opt)=>fetch(p,opt).then(r=>r.ok?r.json():r.json().then(e=>Promise.reject(e)));

async function load(){
  const data = await api('/api/leads');
  const tb = document.querySelector('#leadsTable tbody'); tb.innerHTML='';
  data.forEach(l=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${l.name||''}</td>
      <td>${l.phone||''}</td>
      <td>${l.interested_program||''}</td>
      <td>${l.follow_up_date||''}</td>
      <td>
        <button class="btn" data-act="edit" data-id="${l.id}">Edit</button>
        <button class="btn btn-danger" data-act="del" data-id="${l.id}">Delete</button>
        <button class="btn btn-primary" data-act="convert" data-id="${l.id}">Convert â†’ Student</button>
      </td>`;
    tb.appendChild(tr);
  });
}
document.querySelector('#leadsTable').addEventListener('click', async e=>{
  const b = e.target.closest('button'); if(!b) return;
  const id = b.dataset.id, act = b.dataset.act;
  try{
    if (act==='del'){ await api('/api/leads/'+id,{method:'DELETE'}); load(); }
    else if (act==='edit'){
      const l = await api('/api/leads/'+id);
      for (const k of ['name','phone','email','interested_program','follow_up_date']){
        const el = document.getElementById(k); if (el) el.value = l[k]||'';
      }
      document.getElementById('status').textContent = 'Editing ID '+id;
      document.getElementById('addLead').dataset.editing = id;
      document.getElementById('addLead').textContent = 'Save Lead';
    } else if (act==='convert'){
      await api(`/api/leads/${id}/convert`, { method:'POST' });
      load();
      alert('Lead converted to student.');
    }
  }catch(err){ alert(err.error||'Error'); }
});
document.getElementById('addLead').onclick = async e=>{
  const id = e.target.dataset.editing;
  const body = {
    name: $('#name').value.trim(),
    phone: $('#phone').value.trim(),
    email: $('#email').value.trim(),
    interested_program: $('#interested_program').value.trim(),
    follow_up_date: $('#follow_up_date').value
  };
  const opt = { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) };
  try{
    if (id){ await api('/api/leads/'+id, { ...opt, method:'PUT' }); e.target.dataset.editing=''; e.target.textContent='Add Lead'; }
    else { await api('/api/leads', opt); }
    document.getElementById('status').textContent = 'Saved.';
    load();
  }catch(err){ alert(err.error||'Error'); }
};

load();
</script>
</body></html>