<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Leads</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,Arial,sans-serif;max-width:1100px;margin:24px auto;padding:0 16px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #ddd;padding:8px;text-align:left}
    th{background:#f5f5f5}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .card{flex:1 1 420px;border:1px solid #ddd;border-radius:10px;padding:12px}
    input,select,textarea,button{padding:8px;margin:6px 0;width:100%}
    tr.lead-warn{background:#fff9db}   /* >=7 days and not contacted */
    tr.lead-danger{background:#ffe5e5} /* >=14 days and not contacted */
    .actions button{width:auto;margin-right:6px}
  </style>
</head>
<body>
  <h1>Leads</h1>
  <p><a href="/index.html">Back to Main</a></p>

  <div class="row">
    <div class="card">
      <h2>Add / Edit Lead</h2>
      <input type="hidden" id="lead_id" />
      <label>Name</label><input id="name" />
      <label>Phone</label><input id="phone" />
      <label>Email</label><input id="email" />
      <label>Interested Program</label><input id="interested_program" />
      <label>Follow Up Date</label><input type="date" id="follow_up_date" />
      <label>Status</label>
      <select id="status">
        <option value="">New</option>
        <option>Contacted</option>
        <option>Enrolled</option>
        <option>Not Interested</option>
      </select>
      <label>Notes</label><textarea id="notes" rows="3"></textarea>
      <button id="saveBtn">Save Lead</button>
      <button id="resetBtn" type="button">Reset</button>
    </div>

    <div class="card">
      <h2>Lead List</h2>
      <table id="tbl">
        <thead>
          <tr>
            <th>Name</th><th>Phone</th><th>Email</th><th>Program</th><th>Age (days)</th><th>Status</th><th>Actions</th>
          </tr>
        </thead>
        <tbody><tr><td colspan="7">Loading…</td></tr></tbody>
      </table>
    </div>
  </div>

<script>
function esc(s){return String(s??"")}
function clearForm(){ document.querySelectorAll('#lead_id,#name,#phone,#email,#interested_program,#follow_up_date,#status,#notes')
  .forEach(el=> el.value=""); }
function formData(){
  return {
    name:$('#name').value.trim(),
    phone:$('#phone').value.trim(),
    email:$('#email').value.trim(),
    interested_program:$('#interested_program').value.trim(),
    follow_up_date:$('#follow_up_date').value,
    status:$('#status').value,
    notes:$('#notes').value.trim()
  };
}
const $=sel=>document.querySelector(sel);

async function load(){
  const tb=$('#tbl tbody'); tb.innerHTML='<tr><td colspan="7">Loading…</td></tr>';
  const res=await fetch('/api/leads'); const rows=await res.json();
  if(!Array.isArray(rows)||rows.length===0){tb.innerHTML='<tr><td colspan="7">No leads</td></tr>';return;}
  tb.innerHTML='';
  rows.forEach(l=>{
    const tr=document.createElement('tr');
    const contacted = (l.status||'').toLowerCase()==='contacted' || (l.status||'').toLowerCase()==='enrolled';
    if(!contacted){
      if((l.age_days||0) >= 14) tr.classList.add('lead-danger');
      else if((l.age_days||0) >= 7) tr.classList.add('lead-warn');
    }
    tr.innerHTML = `
      <td>${esc(l.name)}</td>
      <td>${esc(l.phone||'')}</td>
      <td>${esc(l.email||'')}</td>
      <td>${esc(l.interested_program||'')}</td>
      <td>${esc(l.age_days||0)}</td>
      <td>${esc(l.status||'')}</td>
      <td class="actions">
        <button data-id="${l.id}" class="edit">Edit</button>
        <button data-id="${l.id}" class="del">Delete</button>
      </td>`;
    tb.appendChild(tr);
  });
}

document.getElementById('saveBtn').onclick = async ()=>{
  const id = $('#lead_id').value.trim();
  const body = formData();
  const opts = { method: id ? 'PUT' : 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) };
  const url = id ? `/api/leads/${id}` : '/api/leads';
  const r=await fetch(url, opts); const out=await r.json();
  if(!r.ok){ alert(out.error || 'Save failed'); return; }
  clearForm(); load();
};
document.getElementById('resetBtn').onclick = clearForm;

document.getElementById('tbl').addEventListener('click', async (e)=>{
  const btn=e.target.closest('button'); if(!btn) return;
  const id=btn.dataset.id;
  if(btn.classList.contains('edit')){
    // load row into form
    const tr=btn.closest('tr'); const tds=[...tr.children];
    $('#lead_id').value = id;
    $('#name').value = tds[0].textContent;
    $('#phone').value = tds[1].textContent;
    $('#email').value = tds[2].textContent;
    $('#interested_program').value = tds[3].textContent;
    $('#status').value = tds[5].textContent || '';
    // follow_up_date & notes need fetch (optional); leaving as-is
  } else if(btn.classList.contains('del')){
    if(!confirm('Delete this lead?')) return;
    const r=await fetch(`/api/leads/${id}`, {method:'DELETE'}); const out=await r.json();
    if(!r.ok){ alert(out.error||'Delete failed'); return; }
    load();
  }
});

load();
</script>
</body>
</html>
