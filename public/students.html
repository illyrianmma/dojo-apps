<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Students</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif; margin:20px;}
    .nav{margin-bottom:16px}
    .nav a{text-decoration:none; padding:6px 10px; border:1px solid #ccc; border-radius:6px; background:#f7f7f7}
    form input, form button{padding:8px; margin-right:8px}
    table{border-collapse:collapse; width:100%; margin-top:16px}
    th, td{border:1px solid #ddd; padding:8px; text-align:left}
    tr.overdue td{background:#ffe5e5}
    .small{font-size:.9em; color:#666}
  </style>
</head>
<body>
  <div class="nav"><a href="index.html">â¬… Back to Main</a></div>
  <h1>Students</h1>

  <form id="studentForm">
    <input name="name" placeholder="Name" required>
    <input name="phone" placeholder="Phone">
    <input name="email" placeholder="Email">
    <button type="submit">Add Student</button>
    <span class="small">join date = today; renewal = +28 days automatically</span>
  </form>

  <table id="tbl">
    <thead>
      <tr>
        <th>ID</th><th>Name</th><th>Phone</th><th>Email</th>
        <th>Join</th><th>Renewal</th><th>Status</th><th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
async function fetchJSON(url, opts){
  const r = await fetch(url, opts);
  const txt = await r.text();
  try { return JSON.parse(txt); }
  catch { return { ok:false, error:'Invalid JSON', raw:txt }; }
}
function isOverdue(yyyy_mm_dd){
  if (!yyyy_mm_dd) return false;
  const today = new Date().toISOString().slice(0,10);
  return yyyy_mm_dd < today;
}
async function load(){
  const data = await fetchJSON('/api/students');
  const tb = document.querySelector('#tbl tbody');
  tb.innerHTML = '';
  if (!data.ok){
    tb.innerHTML = `<tr><td colspan="8">Error loading: ${data.error||data.raw}</td></tr>`;
    return;
  }
  for (const s of data.students){
    const tr = document.createElement('tr');
    if (isOverdue(s.renewal_date)) tr.classList.add('overdue');
    tr.innerHTML = `
      <td>${s.id}</td>
      <td>${s.name||''}</td>
      <td>${s.phone||''}</td>
      <td>${s.email||''}</td>
      <td>${s.join_date||''}</td>
      <td>${s.renewal_date||''}</td>
      <td>${s.status||''}</td>
      <td>
        <button data-archive="${s.id}">Archive</button>
      </td>`;
    tb.appendChild(tr);
  }
}
document.getElementById('studentForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const body = Object.fromEntries(fd.entries());
  const res = await fetchJSON('/api/students',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  if (!res.ok) { alert('Error: ' + res.error); return; }
  e.target.reset();
  load();
});
document.querySelector('#tbl').addEventListener('click', async (e)=>{
  const id = e.target?.dataset?.archive;
  if (!id) return;
  if (!confirm('Archive this student?')) return;
  const res = await fetchJSON(`/api/students/${id}/archive`, { method:'POST' });
  if (!res.ok) { alert('Error: ' + res.error); return; }
  load();
});
load();
</script>
</body>
</html>
