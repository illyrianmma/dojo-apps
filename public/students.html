<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Students</title>
  <style>
    body{font-family:sans-serif;max-width:1000px;margin:2rem auto}
    table{border-collapse:collapse;width:100%} th,td{border:1px solid #ccc;padding:6px}
    input,select,button{margin:2px}
    img.thumb{height:36px;width:36px;object-fit:cover;border-radius:4px;border:1px solid #ddd}
    .actions a, .actions button{margin-right:.3rem}
    tr.highlight td{background:#dff3ff;}
    a.btn{display:inline-block;padding:.25rem .5rem;border:1px solid #aaa;border-radius:4px;text-decoration:none;color:#000;margin:0 .2rem}
  </style>
</head>
<body>
  <h1>Students</h1>
  <p>
    <a class="btn" href="students_legacy.html">Open Old Students Page</a>
    <a class="btn" href="index.html">Back to Main Page</a>
  </p>

  <h2>Add Student</h2>
  <div>
    <label>First Name <input id="first_name" required></label>
    <label>Last Name <input id="last_name" required></label>
    <label>Phone <input id="phone"></label>
    <label>Program <input id="program"></label>
    <label>Join Date <input type="date" id="start_date"></label>
    <label>Renewal <input type="date" id="renewal_date"></label>
    <label>Email <input id="email"></label>
    <label>Address <input id="address"></label>
    <label>Age <input id="age" type="number" min="0" style="width:5rem"></label>
    <label>Photo URL (optional) <input id="photo_url"></label>
    <label>Upload Photo <input id="photo_file" type="file" accept="image/*"></label>
    <button id="addBtn">Add</button>
  </div>

  <h2>Student List</h2>
  <table>
    <thead>
      <tr><th>Pic</th><th>Name</th><th>Phone</th><th>Program</th><th>Start</th><th>Renewal</th><th>Actions</th></tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <script>
    const fmt = d => d.toISOString().slice(0,10);

    (function(){
      const u = new URL(location.href);
      const m = k => u.searchParams.get(k);
      const map = { first_name:'first_name', last_name:'last_name', phone:'phone', email:'email', program:'program' };
      for (const [q,id] of Object.entries(map)) { const v=m(q); if(v) document.getElementById(id).value=v; }
    })();

    (function(){
      const s = document.getElementById('start_date');
      const r = document.getElementById('renewal_date');
      const t = new Date();
      if(!s.value) s.value = fmt(t);
      if(!r.value){ const d = new Date(t); d.setDate(d.getDate()+28); r.value = fmt(d); }
    })();

    function rowHTML(s){
      const full = (s.first_name||'')+' '+(s.last_name||'');
      const pic  = s.photo ? `<img class="thumb" src="${s.photo}" alt="pic">` : '';
      const oldLink = `students_legacy.html?id=${encodeURIComponent(s.id)}`;
      const payLink = `payments_student.html?student_id=${encodeURIComponent(s.id)}`;
      return `
        <td>${pic}</td>
        <td>${full}</td>
        <td>${s.phone||''}</td>
        <td>${s.program||''}</td>
        <td>${s.start_date||''}</td>
        <td>${s.renewal_date||''}</td>
        <td class="actions">
          <a href="${oldLink}">Old View</a>
          <button class="to-old" data-id="${s.id}">Move to Old</button>
          <a href="${payLink}">View Payments</a>
          <button class="del" data-id="${s.id}">Delete</button>
        </td>
      `;
    }

    async function load(){
      // IMPORTANT: only show active students
      const r = await fetch('/api/students?legacy=false');
      if (!r.ok) { alert('Loading students failed: '+(await r.text())); return; }
      const rows = await r.json();
      const tb = document.getElementById('tbody'); tb.innerHTML='';
      (rows||[]).forEach(s=>{
        const tr = document.createElement('tr'); tr.dataset.id = String(s.id);
        tr.innerHTML = rowHTML(s);
        tb.appendChild(tr);
      });
    }

    async function uploadPhotoIfAny() {
      const f = document.getElementById('photo_file').files[0];
      if (!f) return null;
      const fd = new FormData(); fd.append('image', f);
      const r = await fetch('/api/uploads/image', { method:'POST', body: fd });
      if (!r.ok) { const t=await r.text(); alert('Photo upload failed: '+t); return null; }
      const j = await r.json(); return j.url || null;
    }

    async function addStudent(){
      const first_name = document.getElementById('first_name').value.trim();
      const last_name  = document.getElementById('last_name').value.trim();
      if (!first_name || !last_name) { alert('First and Last name required'); return; }
      const s = document.getElementById('start_date');
      const r = document.getElementById('renewal_date');
      if(!s.value){ const t=new Date(); s.value = fmt(t); }
      if(!r.value){ const t=new Date(); t.setDate(t.getDate()+28); r.value = fmt(t); }

      let photo = await uploadPhotoIfAny();
      if (!photo) {
        const url = document.getElementById('photo_url').value.trim();
        if (url) photo = url;
      }

      const payload = {
        first_name, last_name,
        phone:   document.getElementById('phone').value.trim() || null,
        program: document.getElementById('program').value.trim() || null,
        start_date:   document.getElementById('start_date').value || null,
        renewal_date: document.getElementById('renewal_date').value || null,
        email:   document.getElementById('email').value.trim() || null,
        address: document.getElementById('address').value.trim() || null,
        age:     Number(document.getElementById('age').value || 0) || null,
        photo:   photo || null,
        is_legacy: false
      };

      const rPost = await fetch('/api/students', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if (!rPost.ok) { alert('Error adding student: ' + (await rPost.text())); return; }
      await load();
      document.getElementById('first_name').value = '';
      document.getElementById('last_name').value  = '';
      document.getElementById('photo_file').value = '';
      document.getElementById('photo_url').value  = '';
    }

    document.addEventListener('click', async (e)=>{
      if (e.target.matches('.del')) {
        const id = e.target.dataset.id;
        if (!confirm('Delete this student?')) return;
        const r = await fetch('/api/students/'+encodeURIComponent(id), { method:'DELETE' });
        if (!r.ok) { alert('Error deleting: ' + (await r.text())); return; }
        await load();
      }
      if (e.target.matches('.to-old')) {
        const id = e.target.dataset.id;
        if (!confirm('Move this student to the Old Students page?')) return;
        const r = await fetch('/api/students/'+encodeURIComponent(id)+'/legacy', {
          method:'PUT', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ is_legacy: true })
        });
        if (!r.ok) { alert('Error moving to old: ' + (await r.text())); return; }
        await load(); // reload now shows only active => row disappears
      }
    });

    document.getElementById('addBtn').addEventListener('click', addStudent);
    load();
  </script>
</body>
</html>
